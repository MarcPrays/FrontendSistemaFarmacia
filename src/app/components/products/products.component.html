<div class="products-container">
  <div class="products-header">
    <h1 class="page-title">Gesti√≥n de Productos</h1>
    <div class="user-info">
      <div class="user-avatar">üë§</div>
      <div class="user-details">
        <span class="user-name">Admin</span>
        <span class="user-role">Administrador</span>
      </div>
      <span class="dropdown-icon">‚ñº</span>
    </div>
  </div>

  <div class="search-filters">
    <div class="search-bar">
      <span class="search-icon">üîç</span>
      <input 
        type="text" 
        placeholder="Buscar productos por nombre, c√≥digo o categor√≠a..." 
        [(ngModel)]="searchTerm"
        (input)="searchProducts()"
        class="search-input">
    </div>
    <div class="filter-buttons">
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'todos'"
        (click)="filterProducts('todos')">
        Todos
      </button>
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'stock-bajo'"
        (click)="filterProducts('stock-bajo')">
        Stock Bajo
      </button>
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'sin-stock'"
        (click)="filterProducts('sin-stock')">
        Sin Stock
      </button>
      <button 
        class="filter-btn" 
        [class.active]="selectedFilter === 'activos'"
        (click)="filterProducts('activos')">
        Activos
      </button>
    </div>
  </div>

  <div class="stats-summary">
    <span class="stat-item">{{ stats.total }} Total</span>
    <span class="stat-item warning">{{ stats.lowStock }} Stock Bajo</span>
    <span class="stat-item danger">{{ stats.outOfStock }} Sin Stock</span>
    <button class="add-product-btn" (click)="addProduct()">
      <span>+</span> Nuevo Producto
    </button>
  </div>

  @if (error) {
    <div class="error-message">
      <span>‚ö†Ô∏è</span> {{ error }}
      <button (click)="loadProducts()" class="retry-btn">Reintentar</button>
    </div>
  }

  @if (loading && products.length === 0) {
    <div class="loading-message">
      <span>‚è≥</span> Cargando productos...
    </div>
  }

  <div class="products-table-container">
    @if (!loading || products.length > 0) {
      <table class="products-table">
        <thead>
          <tr>
            <th>IMAGEN</th>
            <th>PRODUCTO</th>
            <th>CATEGOR√çA</th>
            <th>PRESENTACI√ìN</th>
            <th>PRECIO</th>
            <th>STOCK</th>
            <th>ESTADO</th>
            <th>ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          @if (filteredProducts.length === 0) {
            <tr>
              <td colspan="8" class="no-products">
                No se encontraron productos
              </td>
            </tr>
          } @else {
            @for (product of filteredProducts; track product.id) {
              <tr>
                <td>
                  <div class="product-image">
                    @if (product.image) {
                      <img [src]="product.image" [alt]="product.name" (error)="handleImageError(product)">
                    } @else {
                      <span class="image-placeholder">üíä</span>
                    }
                  </div>
                </td>
                <td>
                  <div class="product-info">
                    <div class="product-name">{{ product.name }}</div>
                    <div class="product-code">
                      @if (product.concentration && product.presentation) {
                        {{ product.concentration }} ‚Ä¢ {{ product.presentation }}
                      } @else if (product.concentration) {
                        {{ product.concentration }}
                      } @else if (product.presentation) {
                        {{ product.presentation }}
                      }
                    </div>
                  </div>
                </td>
                <td>
                  <span class="category-badge">{{ product.category?.name || 'Sin categor√≠a' }}</span>
                </td>
                <td>{{ product.presentation || '-' }}</td>
                <td class="price-cell">${{ getProductPrice(product.id).toFixed(2) }}</td>
                <td>
                  <div class="stock-info">
                    <span class="stock-value">{{ getProductStock(product.id) }}</span>
                    <span class="stock-status" [class]="getStockStatus(product.id).class">
                      {{ getStockStatus(product.id).status }}
                    </span>
                  </div>
                </td>
                <td>
                  <span class="status-badge" [class.active]="product.status === 1">
                    {{ product.status === 1 ? 'Activo' : 'Inactivo' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="action-btn edit" (click)="editProduct(product)" title="Editar" [disabled]="loading">
                      ‚úèÔ∏è
                    </button>
                    <button class="action-btn delete" (click)="deleteProduct(product)" title="Eliminar" [disabled]="loading">
                      üóëÔ∏è
                    </button>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    }
  </div>

  <!-- Modal para Crear/Editar Producto -->
  @if (showCreateModal || showEditModal) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ showEditModal ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
          <button class="modal-close" (click)="closeModal()">√ó</button>
        </div>
        
        <div class="modal-body">
          @if (error) {
            <div class="form-error">
              <span>‚ö†Ô∏è</span> {{ error }}
            </div>
          }

          <form (ngSubmit)="saveProduct()" #productForm="ngForm">
            <div class="form-group">
              <label for="name">Nombre del Producto *</label>
              <input 
                type="text" 
                id="name" 
                name="name"
                [(ngModel)]="formData.name"
                required
                class="form-input"
                placeholder="Ej: Paracetamol 500mg">
            </div>

            <div class="form-group">
              <label for="description">Descripci√≥n</label>
              <textarea 
                id="description" 
                name="description"
                [(ngModel)]="formData.description"
                class="form-input"
                rows="3"
                placeholder="Descripci√≥n del medicamento"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="category_id">Categor√≠a *</label>
                <select 
                  id="category_id" 
                  name="category_id"
                  [(ngModel)]="formData.category_id"
                  required
                  class="form-input">
                  @for (category of categories; track category.id) {
                    <option [value]="category.id">{{ category.name }}</option>
                  }
                </select>
              </div>

              <div class="form-group">
                <label for="presentation">Presentaci√≥n *</label>
                <input 
                  type="text" 
                  id="presentation" 
                  name="presentation"
                  [(ngModel)]="formData.presentation"
                  required
                  class="form-input"
                  placeholder="Ej: Tabletas, C√°psulas">
              </div>
            </div>

            <div class="form-group">
              <label for="concentration">Concentraci√≥n *</label>
              <input 
                type="text" 
                id="concentration" 
                name="concentration"
                [(ngModel)]="formData.concentration"
                required
                class="form-input"
                placeholder="Ej: 500mg, 400mg">
            </div>

            <div class="form-group">
              <label for="image">Imagen del Producto</label>
              <div class="image-upload-container">
                @if (imagePreview) {
                  <div class="image-preview">
                    <img [src]="imagePreview" alt="Preview">
                    <button type="button" class="remove-image-btn" (click)="removeImage()">√ó</button>
                  </div>
                } @else {
                  <div class="image-upload-area">
                    <input 
                      type="file" 
                      id="image" 
                      name="image"
                      accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                      (change)="onImageSelected($event)"
                      class="image-input">
                    <label for="image" class="image-upload-label">
                      <span>üì∑</span>
                      <span>Haga clic para seleccionar una imagen</span>
                      <small>JPG, PNG, GIF o WEBP (m√°x. 2MB)</small>
                    </label>
                  </div>
                }
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" (click)="closeModal()" [disabled]="loading">
                Cancelar
              </button>
              <button type="submit" class="btn-save" [disabled]="loading || !productForm.valid">
                @if (loading) {
                  <span>Guardando...</span>
                } @else {
                  <span>{{ showEditModal ? 'Actualizar' : 'Crear' }}</span>
                }
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>
